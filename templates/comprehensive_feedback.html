{% extends "base.html" %}

{% block title %}Resultados de Evaluación - NFT y Propiedad Intelectual{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header con información del estudiante -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Evaluación Completada - NFTs y Propiedad Intelectual
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Estudiante:</strong> {{ student_name }}</p>
                            <p><strong>Carné:</strong> {{ student_carne }}</p>
                            <p><strong>Duración:</strong> {{ duration_minutes }} minutos</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="display-4 text-primary">
                                <strong>{{ "%.1f"|format(total_score) }}/30.0</strong>
                            </div>
                            <p class="text-muted">Puntuación Final</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Evaluación con IA -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-robot me-2"></i>
                        Análisis Inteligente con IA
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Mostrar general_feedback aquí -->
                    <div class="alert alert-info">
                        {{ general_feedback|safe if general_feedback else "Evaluación completada sin análisis de IA específico." }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Evaluación Detallada por Casos -->
    {% for case_data in all_cases_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="fas fa-gavel me-2"></i>
                Caso {{ case_data.case.case_id }}: {{ case_data.case.title }}
            </h5>
            <small class="text-muted">{{ case_data.score|round(1) }}/6.0 puntos</small>
        </div>
        <div class="card-body">
            <p class="text-muted">{{ case_data.case.description[:200] }}...</p>
            
            <!-- Preguntas del caso -->
            {% for i in range(case_data.answers|length) %}
            <div class="question-evaluation mb-4 p-3 border rounded">
                <h6 class="text-primary">Pregunta {{ i + 1 }}</h6>
                <p class="question-text">{{ case_data.case.questions[i].text }}</p>
                
                <!-- Respuesta del estudiante -->
                <div class="student-answer mb-3">
                    <h6 class="text-secondary">Su respuesta:</h6>
                    <p><strong>{{ "Verdadero" if case_data.answers[i].user_bool else "Falso" }}</strong></p>
                    <blockquote class="blockquote">
                        <p>"{{ case_data.answers[i].user_reason }}"</p>
                    </blockquote>
                </div>
                
                <!-- Rúbrica Visual con JavaScript -->
                <div class="rubrica-visual" id="rubrica-caso-{{ case_data.case.case_id }}-pregunta-{{ i }}">
                    <h6 class="text-success">Evaluación por Criterios</h6>
                    <div class="row">
                        <!-- Los 9 criterios se mostrarán aquí con barras de progreso -->
                        <div class="col-md-6">
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Opinión Fundada</label>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 60%">3/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Valores Éticos</label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 80%">4/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Lenguaje Jurídico</label>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 40%">2/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Citas y Precisión</label>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 60%">3/5</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Estructura</label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 80%">4/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Profundidad</label>
                                <div class="progress">
                                    <div class="progress-bar bg-info" style="width: 60%">3/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Capacidad Crítica</label>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" style="width: 50%">2.5/5</div>
                                </div>
                            </div>
                            <div class="criterio-item mb-2">
                                <label class="form-label small">Presentación</label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" style="width: 90%">4.5/5</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feedback de IA -->
                <div class="ai-feedback mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-light text-success">
                                    <small><strong><i class="fas fa-thumbs-up me-1"></i>Fortalezas</strong></small>
                                </div>
                                <div class="card-body p-2">
                                    <small class="fortalezas-text">
                                        <!-- Aquí irá el feedback_fortalezas de la BD -->
                                        Cargando feedback de fortalezas...
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-light text-warning">
                                    <small><strong><i class="fas fa-lightbulb me-1"></i>Mejoras</strong></small>
                                </div>
                                <div class="card-body p-2">
                                    <small class="mejoras-text">
                                        <!-- Aquí irá el feedback_mejoras de la BD -->
                                        Cargando sugerencias de mejora...
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- Acciones -->
    <div class="text-center mt-4">
        <a href="/" class="btn btn-primary">
            <i class="fas fa-home me-2"></i>Volver al Inicio
        </a>
        <button class="btn btn-info" onclick="window.print()">
            <i class="fas fa-print me-2"></i>Imprimir Resultados
        </button>
    </div>
</div>

<!-- Script para cargar datos reales de la BD -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Aquí cargaremos los datos reales de evaluación desde la BD
    // Por ahora mostramos placeholder, luego haremos la llamada AJAX
    console.log('Cargando evaluaciones detalladas...');
    
    // TODO: Hacer fetch a endpoint que devuelva las evaluaciones detalladas
    // fetch('/api/evaluation-details/' + result_id)
    //   .then(response => response.json())
    //   .then(data => {
    //       updateRubricaVisual(data);
    //   });
});

function updateRubricaVisual(evaluations) {
    // Función para actualizar las barras de progreso con datos reales
    console.log('Actualizando visualización de rúbrica:', evaluations);
}
</script>
{% endblock %}