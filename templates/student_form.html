{% extends "base.html" %}
{% block title %}Registro de Participante{% endblock %}

{% block content %}
<!-- Portada con Parallax -->
<section class="course-header parallax-container" style="min-height: 100vh; margin-top: -4rem;">
    <div class="parallax-element" data-speed="0.3" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://legaltech.com.gt/assets/img/nft.png'); background-size: cover; background-position: center center; z-index: -1;"></div>
    <div class="course-header-overlay" style="background: rgba(44, 62, 80, 0.7);"></div>
    <div class="container course-header-content text-center stagger-children">
        <div class="course-badge animate-fade-in"><i class="fas fa-link"></i> NFTs y Propiedad Intelectual</div>
        <h1 class="course-title animate-fade-in-up" style="font-size: clamp(2.5rem, 6vw, 4.5rem);">Sistema de Evaluación Integral</h1>
        <p class="course-subtitle animate-fade-in-up" style="max-width: 700px; margin: 0 auto;">Plataforma de capacitación y evaluación tecnológica para funcionarios judiciales guatemaltecos.</p>
        <div class="mt-5 animate-fade-in-up"><a href="#registro-form" class="btn btn-primary btn-xl"><i class="fas fa-arrow-down"></i> Iniciar Registro</a></div>
    </div>
</section>

<!-- Timer del Examen -->
<div class="exam-timer" data-animate="fade-up">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h6 class="mb-2">
                    <i class="fas fa-clock me-2"></i>
                    Tiempo Restante para Completar el Examen
                </h6>
                <p class="mb-0 text-muted">
                    Fecha límite: <strong>{{ exam_deadline.strftime('%d de %B de %Y a las %H:%M') }} (Hora de Guatemala)</strong>
                </p>
            </div>
            <div class="col-lg-4 text-center text-lg-end mt-2 mt-lg-0">
                <div id="countdown-timer" class="badge badge-warning badge-lg">
                    Calculando...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Formulario de Registro -->
<div class="py-5" id="registro-form">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card" data-animate="fade-up">
                    <div class="card-header text-center">
                        <i class="fas fa-user-graduate fa-3x text-primary mb-3"></i>
                        <h2 class="card-title">Registro de Participante</h2>
                        <p class="card-subtitle">Complete sus datos para acceder al examen de 5 casos NFT (30 puntos máximo)</p>
                    </div>
                    <div class="card-body">
                        <!-- Advertencia importante -->
                        <div class="single-attempt-warning mb-4">
                            <h6 class="mb-2">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                IMPORTANTE: Solo Un Intento Permitido
                            </h6>
                            <p class="mb-0">
                                Cada persona puede completar este examen solamente UNA VEZ. 
                                Asegúrese de estar preparado antes de iniciar.
                            </p>
                        </div>
                        
                        <!-- Lectura obligatoria -->
                        <div class="alert alert-info d-flex">
                            <i class="fas fa-book-open fa-2x me-3"></i>
                            <div>
                                <strong>Lectura Obligatoria:</strong> 
                                Antes de continuar, es indispensable leer el documento 
                                <a href="https://repositorio.uchile.cl/bitstream/handle/2250/199772/NFTs-un-estudio-sobre-el-alcance-de-la-propiedad-intelectual-en-los-tokens-no-fungibles.pdf" target="_blank" class="fw-bold">
                                    "NFTs: Un estudio sobre el alcance de la propiedad intelectual en los tokens no fungibles"
                                </a> 
                                de la Universidad de Chile.
                            </div>
                        </div>
                        
                        <!-- Formulario -->
                        <form method="post" action="{{ url_for('start_exam') }}" class="mt-4" id="registration-form">
                            <div class="form-group mb-4">
                                <label for="student_name" class="form-label">
                                    <i class="fas fa-user me-2"></i>Nombre Completo:
                                </label>
                                <input type="text" id="student_name" name="student_name" 
                                       class="form-control form-control-lg" required 
                                       placeholder="Ingrese su nombre completo"
                                       pattern="[A-Za-zÀ-ÿ\s]{2,50}"
                                       title="Solo letras y espacios, entre 2 y 50 caracteres">
                            </div>
                            
                            <div class="form-group mb-4">
                                <label for="student_carne" class="form-label">
                                    <i class="fas fa-id-card me-2"></i>Número de Identificación:
                                </label>
                                <input type="text" id="student_carne" name="student_carne" 
                                       class="form-control form-control-lg" required 
                                       placeholder="DPI, carné universitario o código asignado"
                                       pattern="[A-Za-z0-9-]{3,20}"
                                       title="Letras, números y guiones, entre 3 y 20 caracteres">
                            </div>
                            
                            <!-- Checkbox de confirmación -->
                            <div class="form-group mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirm-reading" required>
                                    <label class="form-check-label" for="confirm-reading">
                                        <strong>Confirmo que he leído completamente el documento de referencia</strong> 
                                        y entiendo que solo tendré una oportunidad para completar este examen.
                                    </label>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <button type="button" class="btn btn-outline btn-lg me-3" onclick="window.open('{{ url_for('rubric') }}', '_blank')">
                                    <i class="fas fa-clipboard-check me-2"></i>
                                    Ver Rúbrica de Evaluación
                                </button>
                                <button type="submit" class="btn btn-primary btn-xl" id="start-exam-btn" disabled>
                                    <i class="fas fa-rocket me-2"></i>
                                    Iniciar Examen
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Información adicional -->
<div class="py-5 bg-light">
    <div class="container">
        <div class="section-header text-center mb-4">
            <h3 class="section-title">Información del Examen</h3>
        </div>
        
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-bar fa-2x text-primary mb-3"></i>
                        <h6 class="card-title">Sistema de Puntuación</h6>
                        <p class="card-text text-muted">
                            30 puntos máximo • 6 puntos por caso • 
                            3 puntos por pregunta (1.5 veracidad + 1.5 argumentación)
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x text-success mb-3"></i>
                        <h6 class="card-title">Evaluación con IA</h6>
                        <p class="card-text text-muted">
                            Sistema Claude analiza calidad jurídica, terminología apropiada y coherencia argumentativa.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4 mb-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-2x text-warning mb-3"></i>
                        <h6 class="card-title">Anti-Trampa</h6>
                        <p class="card-text text-muted">
                            Detección automática de copy/paste con penalizaciones. 
                            Escriba con sus propias palabras.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const examDeadline = new Date('{{ exam_deadline.isoformat() }}');
    const confirmCheckbox = document.getElementById('confirm-reading');
    const startButton = document.getElementById('start-exam-btn');
    const countdownTimer = document.getElementById('countdown-timer');
    
    // Enable/disable start button based on checkbox
    confirmCheckbox.addEventListener('change', function() {
        startButton.disabled = !this.checked;
        if (this.checked) {
            startButton.classList.remove('btn-secondary');
            startButton.classList.add('btn-primary');
        } else {
            startButton.classList.remove('btn-primary');
            startButton.classList.add('btn-secondary');
        }
    });
    
    // Countdown timer
    function updateCountdown() {
        const now = new Date();
        const timeLeft = examDeadline - now;
        
        if (timeLeft <= 0) {
            countdownTimer.textContent = 'EXAMEN CERRADO';
            countdownTimer.className = 'badge badge-danger badge-lg';
            startButton.disabled = true;
            startButton.innerHTML = '<i class="fas fa-lock me-2"></i>Examen No Disponible';
            return;
        }
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
        
        if (days > 0) {
            countdownTimer.textContent = `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
            countdownTimer.textContent = `${hours}h ${minutes}m ${seconds}s`;
        } else {
            countdownTimer.textContent = `${minutes}m ${seconds}s`;
        }
        
        // Change color based on time left
        if (timeLeft < 3600000) { // Less than 1 hour
            countdownTimer.className = 'badge badge-danger badge-lg';
        } else if (timeLeft < 86400000) { // Less than 1 day
            countdownTimer.className = 'badge badge-warning badge-lg';
        } else {
            countdownTimer.className = 'badge badge-success badge-lg';
        }
    }
    
    // Update countdown every second
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    // Form validation
    const form = document.getElementById('registration-form');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('student_name').value.trim();
        const id = document.getElementById('student_carne').value.trim();
        
        if (!name || !id) {
            e.preventDefault();
            alert('Por favor complete todos los campos requeridos.');
            return;
        }
        
        if (!confirmCheckbox.checked) {
            e.preventDefault();
            alert('Debe confirmar que ha leído el documento de referencia.');
            return;
        }
        
        // Final confirmation
        const confirmed = confirm(
            '¿Está seguro de iniciar el examen?\n\n' +
            'RECUERDE:\n' +
            '• Solo tiene UNA oportunidad\n' +
            '• Debe completar los 5 casos\n' +
            '• Escriba con sus propias palabras\n' +
            '• El sistema detecta copy/paste\n\n' +
            'Click OK para continuar o Cancelar para revisar.'
        );
        
        if (!confirmed) {
            e.preventDefault();
        }
    });
    
    console.log('Student registration form initialized');
});
</script>
{% endblock %}