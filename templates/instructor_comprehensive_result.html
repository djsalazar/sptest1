{% extends 'base.html' %}
{% block content %}
<div class="instructor-result-container">
    <!-- Header Section -->
    <div class="instructor-result-header">
        <div class="header-content">
            <h2>üìä An√°lisis Detallado - NFTs y Propiedad Intelectual</h2>
            <div class="result-meta">
                <div class="meta-grid">
                    <div class="meta-item">
                        <span class="meta-label">üë§ Estudiante:</span>
                        <span class="meta-value">{{ student_name }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">üÜî Identificaci√≥n:</span>
                        <span class="meta-value">{{ student_carne }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">üìÖ Fecha de Examen:</span>
                        <span class="meta-value">{{ result.timestamp[:19].replace('T', ' ') }}</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">üéØ Puntuaci√≥n Total:</span>
                        <span class="meta-value score-display">{{ '%.1f'|format(total_score) }}/100</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructor-tools">
            <div class="tool-buttons">
                <button onclick="exportDetailedReport()" class="btn btn-primary">
                    üìä Exportar Informe
                </button>
                <button onclick="toggleAnalytics()" class="btn btn-secondary">
                    üìà Analytics
                </button>
                <button onclick="window.print()" class="btn btn-secondary">
                    üñ®Ô∏è Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- Performance Summary for Instructor -->
    <div class="instructor-summary">
        <h3>üéØ Resumen de Rendimiento</h3>
        <div class="summary-grid">
            <div class="summary-card accuracy">
                <div class="card-icon">‚öñÔ∏è</div>
                <div class="card-content">
                    <div class="card-value">{{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('user_bool', 'equalto', all_cases_answers.values() | map('map', attribute='answers') | flatten | map(attribute='correct_bool')) | list | length) }}/10</div>
                    <div class="card-label">Respuestas Correctas V/F</div>
                    <div class="card-percentage">{{ ((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('user_bool', 'equalto', all_cases_answers.values() | map('map', attribute='answers') | flatten | map(attribute='correct_bool')) | list | length) / 10 * 100) | round(1) }}%</div>
                </div>
            </div>
            
            <div class="summary-card argumentation">
                <div class="card-icon">‚úçÔ∏è</div>
                <div class="card-content">
                    <div class="card-value">{{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.argument', 'gt', 3) | list | length) }}/10</div>
                    <div class="card-label">Argumentaciones S√≥lidas</div>
                    <div class="card-percentage">{{ ((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.argument', 'gt', 3) | list | length) / 10 * 100) | round(1) }}%</div>
                </div>
            </div>
            
            <div class="summary-card nft-comprehension">
                <div class="card-icon">üîó</div>
                <div class="card-content">
                    <div class="card-value">{{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | selectattr('breakdown.ai_analysis.comprension_nft', 'gt', 3) | list | length) }}/10</div>
                    <div class="card-label">Comprensi√≥n NFT</div>
                    <div class="card-percentage">{{ ((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | selectattr('breakdown.ai_analysis.comprension_nft', 'gt', 3) | list | length) / 10 * 100) | round(1) }}%</div>
                </div>
            </div>
            
            <div class="summary-card penalties">
                <div class="card-icon">‚ö†Ô∏è</div>
                <div class="card-content">
                    <div class="card-value">{{ paste_penalty if paste_penalty > 0 else 0 }}</div>
                    <div class="card-label">Penalizaciones</div>
                    <div class="card-percentage">Copy-paste detectado</div>
                </div>
            </div>
        </div>

        <!-- Performance Indicators -->
        {% if paste_penalty > 0 %}
        <div class="penalty-alert">
            <div class="alert-icon">üö®</div>
            <div class="alert-content">
                <strong>Penalizaci√≥n Aplicada:</strong> Se detect√≥ uso excesivo de copy-paste (-{{ paste_penalty }} puntos). 
                Esto sugiere que el estudiante no desarroll√≥ sus propias respuestas de manera original.
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Advanced Analytics Toggle -->
    <div class="analytics-section" id="analytics-section" style="display: none;">
        <h3>üìà An√°lisis Avanzado</h3>
        <div class="analytics-grid">
            <div class="analytics-card response-quality">
                <h4>üìù Calidad de Respuestas</h4>
                <div class="quality-metrics">
                    <div class="metric-item">
                        <span class="metric-label">Promedio de palabras:</span>
                        <span class="metric-value">{{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | map(attribute='user_reason') | map('split') | map('length') | sum / 10) | round(0) }}</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Respuestas extensas (>150 chars):</span>
                        <span class="metric-value">{{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | map(attribute='user_reason') | selectattr('length', 'gt', 150) | list | length) }}/10</span>
                    </div>
                </div>
                <div class="quality-chart" id="response-quality-chart"></div>
            </div>
            
            <div class="analytics-card ai-criteria">
                <h4>ü§ñ Criterios IA Promedio</h4>
                <div class="ai-metrics">
                    <div class="ai-metric">
                        <span class="ai-label">üîó Comprensi√≥n NFT:</span>
                        <div class="ai-bar">
                            <div class="ai-fill" style="width: {{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | map(attribute='breakdown.ai_analysis.comprension_nft') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | list | length) / 5 * 100) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | list | length) > 0 else 0 }}%"></div>
                        </div>
                        <span class="ai-score">{{ '%.1f'|format((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | map(attribute='breakdown.ai_analysis.comprension_nft') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | list | length)) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.comprension_nft', 'defined') | list | length) > 0 else 0) }}/5</span>
                    </div>
                    <div class="ai-metric">
                        <span class="ai-label">‚öñÔ∏è Aplicaci√≥n Normativa:</span>
                        <div class="ai-bar">
                            <div class="ai-fill" style="width: {{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | map(attribute='breakdown.ai_analysis.aplicacion_normativa') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | list | length) / 5 * 100) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | list | length) > 0 else 0 }}%"></div>
                        </div>
                        <span class="ai-score">{{ '%.1f'|format((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | map(attribute='breakdown.ai_analysis.aplicacion_normativa') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | list | length)) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.aplicacion_normativa', 'defined') | list | length) > 0 else 0) }}/5</span>
                    </div>
                    <div class="ai-metric">
                        <span class="ai-label">üì± Smart Contracts:</span>
                        <div class="ai-bar">
                            <div class="ai-fill" style="width: {{ (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | map(attribute='breakdown.ai_analysis.smart_contracts') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | list | length) / 5 * 100) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | list | length) > 0 else 0 }}%"></div>
                        </div>
                        <span class="ai-score">{{ '%.1f'|format((all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | map(attribute='breakdown.ai_analysis.smart_contracts') | sum / (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | list | length)) if (all_cases_answers.values() | map('map', attribute='answers') | flatten | selectattr('breakdown.ai_analysis.smart_contracts', 'defined') | list | length) > 0 else 0) }}/5</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Case Analysis -->
    {% for case_id, case_data in all_cases_answers.items() %}
    <div class="case-detail">
        <div class="case-detail-header">
            <div class="case-info">
                <div class="case-number">{{ case_id }}</div>
                <div class="case-title-info">
                    <h3>{{ cases[case_id|int].title }}</h3>
                    <div class="case-meta">
                        <span class="case-type">üîó Caso NFT</span>
                        <span class="case-score">{{ '%.1f'|format(case_data.answers | map(attribute='score') | sum) }}/20 puntos</span>
                    </div>
                </div>
            </div>
            
            <div class="case-actions">
                <button onclick="toggleCaseDetails('case_{{ case_id }}')" class="btn btn-outline">
                    <span class="toggle-text">Ver Detalles</span>
                    <span class="toggle-icon">‚ñº</span>
                </button>
            </div>
        </div>
        
        <div class="case-description">
            <strong>üìã Descripci√≥n del Caso:</strong>
            <p>{{ cases[case_id|int].description }}</p>
        </div>
        
        <div class="case-details" id="case_{{ case_id }}" style="display: none;">
            {% for answer in case_data.answers %}
            <div class="question-detail">
                <div class="question-detail-header">
                    <h4>Pregunta {{ loop.index }}</h4>
                    <div class="question-score {{ 'score-high' if answer.score >= 8 else 'score-medium' if answer.score >= 6 else 'score-low' }}">
                        {{ '%.1f'|format(answer.score) }}/10
                    </div>
                </div>
                
                <!-- Original Question -->
                <div class="original-question">
                    <strong>‚ùì Afirmaci√≥n:</strong>
                    <p>{{ answer.question_text }}</p>
                </div>
                
                <!-- Answer Analysis -->
                <div class="answer-analysis">
                    <div class="answer-comparison">
                        <div class="student-response {{ 'correct' if answer.user_bool == answer.correct_bool else 'incorrect' }}">
                            <div class="response-label">üë§ Estudiante:</div>
                            <div class="response-value">
                                {{ 'Verdadero' if answer.user_bool else 'Falso' }}
                                {% if answer.user_bool == answer.correct_bool %}
                                <span class="result-icon correct">‚úÖ</span>
                                {% else %}
                                <span class="result-icon incorrect">‚ùå</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="correct-response">
                            <div class="response-label">‚úÖ Correcta:</div>
                            <div class="response-value">
                                {{ 'Verdadero' if answer.correct_bool else 'Falso' }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Score Breakdown -->
                <div class="score-breakdown">
                    <h5>üìä Desglose Detallado</h5>
                    <div class="breakdown-items">
                        <div class="breakdown-item {{ 'success' if answer.user_bool == answer.correct_bool else 'error' }}">
                            <span class="breakdown-label">‚öñÔ∏è Veracidad:</span>
                            <span class="breakdown-value">{{ '%.1f'|format(answer.breakdown.truth) }}/5</span>
                            <div class="breakdown-bar">
                                <div class="breakdown-fill" style="width: {{ (answer.breakdown.truth / 5) * 100 }}%"></div>
                            </div>
                        </div>
                        <div class="breakdown-item">
                            <span class="breakdown-label">‚úçÔ∏è Argumentaci√≥n:</span>
                            <span class="breakdown-value">{{ '%.1f'|format(answer.breakdown.argument) }}/5</span>
                            <div class="breakdown-bar">
                                <div class="breakdown-fill" style="width: {{ (answer.breakdown.argument / 5) * 100 }}%"></div>
                            </div>
                        </div>
                        {% if answer.breakdown.ai_penalty != 0 %}
                        <div class="breakdown-item penalty">
                            <span class="breakdown-label">‚ö†Ô∏è Penalizaciones:</span>
                            <span class="breakdown-value">{{ '%.1f'|format(answer.breakdown.ai_penalty) }}</span>
                            <div class="penalty-indicator">
                                {% if answer.breakdown.ai_penalty < -0.5 %}
                                Penalizaci√≥n significativa
                                {% else %}
                                Penalizaci√≥n menor
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Student Justification -->
                <div class="student-justification">
                    <h5>‚úçÔ∏è Justificaci√≥n del Estudiante</h5>
                    <div class="justification-content">
                        {{ answer.user_reason }}
                    </div>
                    <div class="justification-metrics">
                        <span class="metric">üìè {{ answer.user_reason|length }} caracteres</span>
                        <span class="metric">üìù {{ answer.user_reason.split()|length }} palabras</span>
                        <span class="metric">‚è±Ô∏è {{ '%.1f'|format(answer.user_reason|length / 200) }} min lectura</span>
                    </div>
                </div>
                
                <!-- AI Analysis (if available) -->
                {% if answer.breakdown.ai_analysis and answer.breakdown.ai_analysis.comprension_nft %}
                <div class="ai-detailed-analysis">
                    <h5>ü§ñ An√°lisis Detallado con IA</h5>
                    <div class="ai-criteria-detailed">
                        <div class="criteria-grid">
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">üîó</span>
                                    <span class="criterion-name">Comprensi√≥n NFT</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.comprension_nft }}">
                                        {{ answer.breakdown.ai_analysis.comprension_nft }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.comprension_nft / 5) * 100 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">‚öñÔ∏è</span>
                                    <span class="criterion-name">Aplicaci√≥n Normativa</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.aplicacion_normativa }}">
                                        {{ answer.breakdown.ai_analysis.aplicacion_normativa }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.aplicacion_normativa / 5) * 100 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">üì±</span>
                                    <span class="criterion-name">Smart Contracts</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.smart_contracts }}">
                                        {{ answer.breakdown.ai_analysis.smart_contracts }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.smart_contracts / 5) * 100 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">üèõÔ∏è</span>
                                    <span class="criterion-name">Marco Constitucional</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.marco_constitucional }}">
                                        {{ answer.breakdown.ai_analysis.marco_constitucional }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.marco_constitucional / 5) * 100 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">üß†</span>
                                    <span class="criterion-name">Coherencia</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.coherencia }}">
                                        {{ answer.breakdown.ai_analysis.coherencia }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.coherencia / 5) * 100 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="criterion-detail">
                                <div class="criterion-header">
                                    <span class="criterion-icon">üí°</span>
                                    <span class="criterion-name">Aplicaci√≥n Pr√°ctica</span>
                                    <span class="criterion-score score-{{ answer.breakdown.ai_analysis.aplicacion_practica }}">
                                        {{ answer.breakdown.ai_analysis.aplicacion_practica }}/5
                                    </span>
                                </div>
                                <div class="criterion-progress">
                                    <div class="criterion-fill" style="width: {{ (answer.breakdown.ai_analysis.aplicacion_practica / 5) * 100 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if answer.breakdown.feedback %}
                    <div class="ai-feedback-detailed">
                        <h6>üí¨ Retroalimentaci√≥n Espec√≠fica de IA:</h6>
                        <div class="feedback-text">
                            {{ answer.breakdown.feedback }}
                        </div>
                        <div class="feedback-tags">
                            {% if 'NFT' in answer.breakdown.feedback or 'token' in answer.breakdown.feedback %}
                            <span class="tag nft-tag">üîó NFT</span>
                            {% endif %}
                            {% if 'smart contract' in answer.breakdown.feedback %}
                            <span class="tag contract-tag">üìÑ Smart Contract</span>
                            {% endif %}
                            {% if 'constitucional' in answer.breakdown.feedback %}
                            <span class="tag constitutional-tag">üèõÔ∏è Constitucional</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="ai-analysis-unavailable">
                    <div class="unavailable-notice">
                        <span class="unavailable-icon">üîß</span>
                        <span class="unavailable-text">An√°lisis de IA no disponible para esta respuesta</span>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- Event Logs Section -->
    {% if events %}
    <div class="events-section">
        <h3>üìã Registro de Eventos</h3>
        <div class="events-container">
            <div class="events-header">
                <span class="event-time-header">‚è∞ Hora</span>
                <span class="event-type-header">üîñ Tipo</span>
                <span class="event-details-header">üìù Detalles</span>
            </div>
            {% for event in events %}
            <div class="event-item {{ 'suspicious' if 'paste' in event.event_type.lower() else 'normal' }}">
                <span class="event-time">{{ event.event_time[11:19] }}</span>
                <span class="event-type">
                    {% if 'paste' in event.event_type.lower() %}
                    üìã Copy-Paste
                    {% elif 'start' in event.event_type.lower() %}
                    ‚ñ∂Ô∏è Inicio
                    {% elif 'end' in event.event_type.lower() %}
                    ‚èπÔ∏è Fin
                    {% else %}
                    üìù {{ event.event_type }}
                    {% endif %}
                </span>
                <span class="event-details">
                    {% if event.details %}
                    {{ event.details }}
                    {% else %}
                    Evento est√°ndar de interacci√≥n
                    {% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
        
        {% if events | selectattr('event_type', 'search', 'paste') | list | length > 0 %}
        <div class="events-warning">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <div class="warning-text">
                <strong>Actividad Sospechosa Detectada:</strong> 
                Se registraron {{ events | selectattr('event_type', 'search', 'paste') | list | length }} eventos de copy-paste. 
                Esto puede indicar que el estudiante copi√≥ contenido externo en lugar de redactar respuestas originales.
            </div>
        </div>
        {% endif %}
    {% else %}
    <div class="no-events">
        <div class="no-events-icon">üì≠</div>
        <div class="no-events-text">
            <p>No se registraron eventos de interacci√≥n espec√≠ficos para este examen.</p>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            ‚Üê Volver al Dashboard
        </a>
        <button onclick="generateStudentReport()" class="btn btn-primary">
            üìÑ Generar Reporte Estudiante
        </button>
        <button onclick="exportInstructorData()" class="btn btn-outline">
            üìä Exportar Datos
        </button>
    </div>
</div>

<style>
.instructor-result-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
}

/* Header Section */
.instructor-result-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: var(--shadow);
}

.instructor-result-header h2 {
    margin: 0 0 1rem 0;
    color: var(--white);
    font-size: 1.8rem;
}

.meta-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.meta-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.meta-label {
    font-size: 0.9rem;
    opacity: 0.8;
}

.meta-value {
    font-weight: 600;
    font-size: 1.1rem;
}

.score-display {
    font-size: 1.3rem;
    color: #ffd700;
}

.instructor-tools {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 1rem;
}

.tool-buttons {
    display: flex;
    gap: 1rem;
}

.tool-buttons .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 500;
}

/* Summary Section */
.instructor-summary {
    background: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    border: 1px solid #e1e8ed;
}

.instructor-summary h3 {
    margin: 0 0 1.5rem 0;
    color: var(--primary-color);
    text-align: center;
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border-left: 5px solid;
    transition: var(--transition);
}

.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.summary-card.accuracy {
    background: rgba(39, 174, 96, 0.05);
    border-left-color: var(--success-color);
}

.summary-card.argumentation {
    background: rgba(52, 152, 219, 0.05);
    border-left-color: var(--secondary-color);
}

.summary-card.nft-comprehension {
    background: rgba(156, 39, 176, 0.05);
    border-left-color: #9c27b0;
}

.summary-card.penalties {
    background: rgba(231, 76, 60, 0.05);
    border-left-color: var(--accent-color);
}

.card-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.card-content {
    flex: 1;
}

.card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.card-label {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.25rem;
}

.card-percentage {
    font-size: 0.9rem;
    color: var(--dark-gray);
}

/* Penalty Alert */
.penalty-alert {
    background: rgba(231, 76, 60, 0.1);
    border: 2px solid #e74c3c;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    margin-top: 1.5rem;
}

.alert-icon {
    font-size: 2rem;
    color: #e74c3c;
    flex-shrink: 0;
}

.alert-content {
    color: #721c24;
    line-height: 1.6;
}

/* Analytics Section */
.analytics-section {
    background: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    border: 1px solid #e1e8ed;
}

.analytics-section h3 {
    margin: 0 0 1.5rem 0;
    color: var(--primary-color);
    text-align: center;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.analytics-card {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    border-left: 4px solid var(--secondary-color);
}

.analytics-card h4 {
    margin: 0 0 1rem 0;
    color: var(--primary-color);
}

/* Quality Metrics */
.quality-metrics {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.metric-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e1e8ed;
}

.metric-label {
    font-weight: 500;
    color: var(--primary-color);
}

.metric-value {
    font-weight: 600;
    color: var(--secondary-color);
}

/* AI Metrics */
.ai-metrics {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.ai-metric {
    display: grid;
    grid-template-columns: 1fr 2fr auto;
    gap: 1rem;
    align-items: center;
}

.ai-label {
    font-weight: 500;
    color: var(--primary-color);
    font-size: 0.9rem;
}

.ai-bar {
    height: 8px;
    background: #e1e8ed;
    border-radius: 4px;
    overflow: hidden;
}

.ai-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary-color), var(--success-color));
    transition: width 0.3s ease;
}

.ai-score {
    font-weight: 600;
    color: var(--primary-color);
    min-width: 40px;
    text-align: right;
}

/* Case Details */
.case-detail {
    background: var(--white);
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    border: 1px solid #e1e8ed;
    overflow: hidden;
}

.case-detail-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 1.5rem;
    border-bottom: 1px solid #e1e8ed;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.case-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.case-number {
    background: var(--secondary-color);
    color: var(--white);
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 700;
}

.case-title-info h3 {
    margin: 0 0 0.5rem 0;
    color: var(--primary-color);
    font-size: 1.3rem;
}

.case-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.case-type {
    background: rgba(156, 39, 176, 0.1);
    color: #9c27b0;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.case-score {
    font-weight: 600;
    color: var(--primary-color);
}

.case-actions .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toggle-icon {
    transition: transform 0.3s ease;
}

.case-actions .btn.active .toggle-icon {
    transform: rotate(180deg);
}

.case-description {
    padding: 1.5rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e1e8ed;
    color: #495057;
    line-height: 1.6;
}

.case-details {
    transition: all 0.3s ease;
}

/* Question Details */
.question-detail {
    padding: 2rem;
    border-bottom: 1px solid #e1e8ed;
}

.question-detail:last-child {
    border-bottom: none;
}

.question-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f0f0f0;
}

.question-detail-header h4 {
    margin: 0;
    color: var(--primary-color);
    font-size: 1.2rem;
}

.question-score {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    color: var(--white);
    font-weight: 700;
    font-size: 1.1rem;
}

.score-high { background-color: #27ae60; }
.score-medium { background-color: #f39c12; color: #000; }
.score-low { background-color: #e74c3c; }

.original-question {
    background: linear-gradient(135deg, #e8f4f8 0%, #f0f8ff 100%);
    border-left: 4px solid var(--secondary-color);
    padding: 1.5rem;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    margin-bottom: 1.5rem;
}

.original-question strong {
    color: var(--primary-color);
}

.original-question p {
    margin: 0.5rem 0 0 0;
    color: var(--primary-color);
    line-height: 1.6;
}

/* Answer Analysis */
.answer-analysis {
    margin-bottom: 1.5rem;
}

.answer-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.student-response, .correct-response {
    padding: 1rem;
    border-radius: var(--border-radius);
    border: 2px solid;
}

.student-response.correct {
    border-color: var(--success-color);
    background: rgba(39, 174, 96, 0.05);
}

.student-response.incorrect {
    border-color: var(--accent-color);
    background: rgba(231, 76, 60, 0.05);
}

.correct-response {
    border-color: var(--success-color);
    background: rgba(39, 174, 96, 0.05);
}

.response-label {
    font-weight: 600;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.response-value {
    font-size: 1.2rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.result-icon {
    font-size: 1.3rem;
}

.result-icon.correct { color: var(--success-color); }
.result-icon.incorrect { color: var(--accent-color); }

/* Score Breakdown */
.score-breakdown {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
}

.score-breakdown h5 {
    margin: 0 0 1rem 0;
    color: var(--primary-color);
}

.breakdown-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.breakdown-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: var(--white);
    border-radius: var(--border-radius);
    border-left: 4px solid #e1e8ed;
}

.breakdown-item.success {
    border-left-color: var(--success-color);
}

.breakdown-item.error {
    border-left-color: var(--accent-color);
}

.breakdown-item.penalty {
    border-left-color: var(--warning-color);
}

.breakdown-label {
    font-weight: 500;
    color: var(--primary-color);
}

.breakdown-value {
    font-weight: 700;
    color: var(--primary-color);
    min-width: 60px;
    text-align: right;
}

.breakdown-bar {
    height: 8px;
    background: #e1e8ed;
    border-radius: 4px;
    overflow: hidden;
}

.breakdown-fill {
    height: 100%;
    background: var(--secondary-color);
    transition: width 0.3s ease;
}

.penalty-indicator {
    font-size: 0.85rem;
    color: var(--warning-color);
    font-weight: 500;
}

/* Student Justification */
.student-justification {
    margin-bottom: 1.5rem;
}

.student-justification h5 {
    margin: 0 0 1rem 0;
    color: var(--primary-color);
}

.justification-content {
    background: var(--white);
    border: 2px solid #e1e8ed;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    line-height: 1.6;
    color: #495057;
    margin-bottom: 1rem;
}

.justification-metrics {
    display: flex;
    gap: 2rem;
    font-size: 0.9rem;
    color: var(--dark-gray);
}

.metric {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* AI Detailed Analysis */
.ai-detailed-analysis {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    border-left: 5px solid #9c27b0;
    padding: 1.5rem;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    margin-bottom: 1rem;
}

.ai-detailed-analysis h5 {
    margin: 0 0 1rem 0;
    color: #7b1fa2;
}

.criteria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.criterion-detail {
    background: rgba(255,255,255,0.7);
    padding: 1rem;
    border-radius: var(--border-radius);
}

.criterion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.criterion-icon {
    font-size: 1.1rem;
}

.criterion-name {
    flex: 1;
    font-weight: 500;
    color: var(--primary-color);
    margin: 0 1rem;
    font-size: 0.9rem;
}

.criterion-score {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    color: var(--white);
    font-weight: 600;
    font-size: 0.85rem;
}

.criterion-progress {
    height: 6px;
    background: rgba(0,0,0,0.1);
    border-radius: 3px;
    overflow: hidden;
}

.criterion-fill {
    height: 100%;
    background: var(--secondary-color);
    transition: width 0.3s ease;
}

/* AI Feedback */
.ai-feedback-detailed {
    background: rgba(255,255,255,0.8);
    border-radius: var(--border-radius);
    padding: 1rem;
    margin-top: 1rem;
}

.ai-feedback-detailed h6 {
    margin: 0 0 0.75rem 0;
    color: #7b1fa2;
}

.feedback-text {
    color: #4a148c;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.feedback-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.tag {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 500;
}

.nft-tag { background: rgba(156, 39, 176, 0.1); color: #9c27b0; }
.contract-tag { background: rgba(52, 152, 219, 0.1); color: #3498db; }
.constitutional-tag { background: rgba(39, 174, 96, 0.1); color: #27ae60; }

/* AI Analysis Unavailable */
.ai-analysis-unavailable {
    background: rgba(108, 117, 125, 0.1);
    border: 2px dashed #6c757d;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.unavailable-notice {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: var(--dark-gray);
}

.unavailable-icon {
    font-size: 1.5rem;
    opacity: 0.6;
}

/* Events Section */
.events-section {
    background: var(--white);
    padding: 2rem;
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    border: 1px solid #e1e8ed;
}

.events-section h3 {
    margin: 0 0 1.5rem 0;
    color: var(--primary-color);
    text-align: center;
}

.events-container {
    background: #f8f9fa;
    border-radius: var(--border-radius);
    overflow: hidden;
}

.events-header {
    display: grid;
    grid-template-columns: 120px 150px 1fr;
    gap: 1rem;
    padding: 1rem;
    background: var(--primary-color);
    color: var(--white);
    font-weight: 600;
}

.event-item {
    display: grid;
    grid-template-columns: 120px 150px 1fr;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid #e1e8ed;
    align-items: center;
}

.event-item:last-child {
    border-bottom: none;
}

.event-item.suspicious {
    background: rgba(231, 76, 60, 0.05);
    border-left: 4px solid var(--accent-color);
}

.event-item.normal {
    background: var(--white);
}

.event-time {
    font-family: monospace;
    font-weight: 500;
    color: var(--primary-color);
}

.event-type {
    font-weight: 500;
    color: var(--primary-color);
}

.event-details {
    color: #495057;
    font-size: 0.9rem;
}

/* Events Warning */
.events-warning {
    background: rgba(231, 76, 60, 0.1);
    border: 2px solid #e74c3c;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-top: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.warning-icon {
    font-size: 2rem;
    color: #e74c3c;
    flex-shrink: 0;
}

.warning-text {
    color: #721c24;
    line-height: 1.6;
}

/* No Events */
.no-events {
    text-align: center;
    padding: 2rem;
    color: var(--dark-gray);
}

.no-events-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.6;
}

.no-events-text p {
    margin: 0;
    font-size: 1.1rem;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
}

.action-buttons .btn {
    padding: 1rem 2rem;
    border-radius: 25px;
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 768px) {
    .instructor-result-container {
        padding: 1rem;
    }
    
    .instructor-result-header {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
    }
    
    .meta-grid {
        grid-template-columns: 1fr;
    }
    
    .tool-buttons {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .case-detail-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .answer-comparison {
        grid-template-columns: 1fr;
    }
    
    .criteria-grid {
        grid-template-columns: 1fr;
    }
    
    .events-header,
    .event-item {
        grid-template-columns: 80px 100px 1fr;
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
    
    .action-buttons .btn {
        width: 100%;
        max-width: 300px;
    }
}

/* Print Styles */
@media print {
    .instructor-tools,
    .action-buttons {
        display: none;
    }
    
    .instructor-result-container {
        box-shadow: none;
    }
    
    .case-detail,
    .instructor-summary,
    .events-section {
        box-shadow: none;
        border: 1px solid #ccc;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Instructor result view initialized');
    
    // Initialize analytics if needed
    initializeAnalytics();
});

function toggleCaseDetails(caseId) {
    const details = document.getElementById(caseId);
    const button = document.querySelector(`[onclick="toggleCaseDetails('${caseId}')"]`);
    
    if (details.style.display === 'none' || details.style.display === '') {
        details.style.display = 'block';
        button.innerHTML = '<span class="toggle-text">Ocultar Detalles</span><span class="toggle-icon">‚ñ≤</span>';
        button.classList.add('active');
    } else {
        details.style.display = 'none';
        button.innerHTML = '<span class="toggle-text">Ver Detalles</span><span class="toggle-icon">‚ñº</span>';
        button.classList.remove('active');
    }
}

function toggleAnalytics() {
    const analytics = document.getElementById('analytics-section');
    const button = event.target;
    
    if (analytics.style.display === 'none' || analytics.style.display === '') {
        analytics.style.display = 'block';
        button.textContent = 'üìà Ocultar Analytics';
    } else {
        analytics.style.display = 'none';
        button.textContent = 'üìà Analytics';
    }
}

function initializeAnalytics() {
    // Initialize any charts or analytics visualizations
    console.log('üìà Analytics initialized');
}

function exportDetailedReport() {
    // Generate detailed report
    const reportData = {
        student: '{{ student_name }}',
        identification: '{{ student_carne }}',
        date: '{{ result.timestamp[:19] }}',
        totalScore: {{ total_score }},
        timestamp: new Date().toISOString()
    };
    
    // Create downloadable report
    const dataStr = JSON.stringify(reportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = `informe_detallado_${reportData.identification}_NFT_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
    console.log('üìä Detailed report exported');
}

function generateStudentReport() {
    // Generate a summary report for the student
    alert('üìÑ Generando reporte para estudiante...\n\nEsta funcionalidad crear√° un resumen personalizado con recomendaciones espec√≠ficas.');
}

function exportInstructorData() {
    // Export data for instructor analysis
    const csvData = [
        ['Criterio', 'Puntuaci√≥n', 'Porcentaje'],
        ['Precisi√≥n V/F', '{{ (all_cases_answers.values() | map("map", attribute="answers") | flatten | selectattr("user_bool", "equalto", all_cases_answers.values() | map("map", attribute="answers") | flatten | map(attribute="correct_bool")) | list | length) }}/10', '{{ ((all_cases_answers.values() | map("map", attribute="answers") | flatten | selectattr("user_bool", "equalto", all_cases_answers.values() | map("map", attribute="answers") | flatten | map(attribute="correct_bool")) | list | length) / 10 * 100) | round(1) }}%'],
        ['Puntuaci√≥n Total', '{{ "%.1f"|format(total_score) }}/100', '{{ "%.1f"|format(total_score) }}%']
    ];
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvData.forEach(row => {
        csvContent += row.join(",") + "\n";
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `datos_instructor_{{ student_carne }}_NFT.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('üìä Instructor data exported');
}
</script>
{% endblock %}