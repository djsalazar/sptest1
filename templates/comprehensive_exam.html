{% extends "base.html" %}
{% block title %}Examen Integral{% endblock %}
{% block page_title %}Examen Integral{% endblock %}

{% block content %}
<form method="POST" id="exam-form" action="{{ url_for('submit_comprehensive') }}">
    <div class="row align-items-center mb-5" data-animate="fade-up">
        <div class="col-lg-8">
            <div class="section-header text-start mb-0">
                <h2 class="section-title">Examen Integral de Evaluaci√≥n</h2>
                <p class="section-subtitle">Complete los 5 casos de estudio. Su progreso se guardar√° autom√°ticamente.</p>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="dashboard-card text-center">
                <h6 class="text-muted mb-3">Progreso Total</h6>
                <div class="progress-ring mx-auto" data-progress="0" id="progress-ring">
                    <svg width="100" height="100" viewBox="0 0 120 120">
                        <circle class="progress-ring-circle progress-ring-background" stroke-width="10" cx="60" cy="60" r="52"></circle>
                        <circle class="progress-ring-circle progress-ring-progress" stroke-width="10" cx="60" cy="60" r="52"></circle>
                    </svg>
                    <div class="progress-ring-text" id="progress-text">0%</div>
                </div>
            </div>
        </div>
    </div>

    {% for case_data in all_cases_data %}
    <div class="card card-animated-border mb-4" data-animate="fade-up">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white" style="width: 40px; height: 40px; font-weight: 700;">{{ loop.index }}</div>
                <h5 class="card-title m-0">{{ case_data.case.title }}</h5>
            </div>
            <div>
                <span class="badge badge-light me-2">üîó NFT</span>
                <span class="badge badge-info">‚öñÔ∏è PI</span>
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted">{{ case_data.case.description }}</p>
            <hr>
            {% for question in case_data.questions %}
            <div class="mb-4">
                <h6><strong>Pregunta {{ loop.index }}:</strong> {{ question }}</h6>
                
                <!-- === NOMBRES CORREGIDOS PARA BACKEND FLASK === -->
                <div class="d-flex gap-3 mt-3">
                    <!-- CORRECCI√ìN: Usar los nombres que espera Flask: q_{case_id}_{q_index}_bool -->
                    <input type="radio" 
                           name="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_bool" 
                           value="True" 
                           class="d-none" 
                           required 
                           id="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_true">
                    <label class="btn btn-outline flex-grow-1" for="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_true">
                        Verdadero
                    </label>

                    <input type="radio" 
                           name="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_bool" 
                           value="False" 
                           class="d-none" 
                           required 
                           id="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_false">
                    <label class="btn btn-outline flex-grow-1" for="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_false">
                        Falso
                    </label>
                </div>
                
                <!-- CORRECCI√ìN: Textarea con nombre correcto para Flask -->
                <div class="form-group mt-3">
                    <textarea class="form-control" 
                              name="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_reason" 
                              placeholder="Justifique su respuesta (m√≠nimo 50 caracteres)..." 
                              required 
                              minlength="50" 
                              rows="5"
                              data-case-id="{{ case_data.case.case_id }}"
                              data-question-index="{{ loop.index0 }}"></textarea>
                    <!-- El contador se a√±adir√° aqu√≠ por JavaScript -->
                </div>
                
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <div class="text-center mt-5" data-animate="fade-up">
        <button type="submit" class="btn btn-success btn-xl" id="submit-button" disabled>
            <i class="fas fa-clock me-2"></i>Complete todas las preguntas
        </button>
    </div>
</form>

<!-- Estilos espec√≠ficos para el examen -->
<style>
/* Estilos para botones de radio seleccionados - CORRECCI√ìN CR√çTICA */
input[type="radio"]:checked + label.btn-outline {
    background-color: var(--theme-5-primary, #3498db) !important;
    color: white !important;
    border-color: var(--theme-5-primary, #3498db) !important;
    box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3) !important;
    transform: translateY(-2px);
}

/* Suavizar transiciones */
label.btn-outline {
    transition: all 0.2s ease-in-out !important;
}

/* Contador de caracteres */
.char-counter {
    font-size: 0.85rem;
    margin-top: 0.5rem;
    text-align: right;
}

.char-counter.valid {
    color: #28a745;
}

.char-counter.invalid {
    color: #dc3545;
}

.char-counter.warning {
    color: #ffc107;
}

/* Progress ring animations */
.progress-ring-circle {
    transition: stroke-dashoffset 0.5s ease-in-out;
}
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log('Inicializando sistema de examen...');
    
    // --- CONFIGURACI√ìN ---
    const MIN_CHARS = 50;
    const TOTAL_QUESTIONS = {{ all_cases_data|length * 2 }};
    const form = document.getElementById('exam-form');
    const submitButton = document.getElementById('submit-button');

    // --- FUNCI√ìN: SETUP CONTADOR DE CARACTERES ---
    function setupCharacterCounter(textarea) {
        console.log('Configurando contador para:', textarea.name);
        
        // Crear el div contador
        const counterDiv = document.createElement('div');
        counterDiv.className = 'char-counter invalid';
        counterDiv.innerHTML = '<span class="current-count">0</span> / ' + MIN_CHARS + ' caracteres m√≠nimos';
        
        // Insertarlo despu√©s del textarea
        textarea.parentNode.insertBefore(counterDiv, textarea.nextSibling);
        
        // Listener para actualizar contador
        textarea.addEventListener('input', function() {
            const count = this.value.length;
            const span = counterDiv.querySelector('.current-count');
            span.textContent = count;
            
            // Cambiar clase seg√∫n el conteo
            counterDiv.classList.remove('valid', 'invalid', 'warning');
            if (count >= MIN_CHARS) {
                counterDiv.classList.add('valid');
            } else if (count > 0) {
                counterDiv.classList.add('warning');
            } else {
                counterDiv.classList.add('invalid');
            }
            
            // Actualizar progreso general
            updateOverallProgress();
        });
    }

    // --- FUNCI√ìN: ACTUALIZAR PROGRESO GENERAL ---
    function updateOverallProgress() {
        let completedCount = 0;
        
        // Contar preguntas completadas
        const textareas = document.querySelectorAll('textarea[name*="_reason"]');
        textareas.forEach(textarea => {
            // Buscar el radio button correspondiente
            const caseId = textarea.dataset.caseId;
            const questionIndex = textarea.dataset.questionIndex;
            const radioName = `q_${caseId}_${questionIndex}_bool`;
            const radioChecked = document.querySelector(`input[name="${radioName}"]:checked`);
            
            // Contar como completada si tiene radio seleccionado Y m√≠nimo de caracteres
            if (radioChecked && textarea.value.length >= MIN_CHARS) {
                completedCount++;
            }
        });

        // Calcular porcentaje
        const percentage = Math.round((completedCount / TOTAL_QUESTIONS) * 100);
        
        // Actualizar anillo de progreso
        const progressText = document.getElementById('progress-text');
        if (progressText) {
            progressText.textContent = percentage + '%';
        }

        // Actualizar bot√≥n de env√≠o
        if (completedCount === TOTAL_QUESTIONS) {
            submitButton.disabled = false;
            submitButton.classList.remove('btn-secondary');
            submitButton.classList.add('btn-success');
            submitButton.innerHTML = '<i class="fas fa-check-double me-2"></i> Finalizar y Enviar Evaluaci√≥n';
        } else {
            submitButton.disabled = true;
            submitButton.classList.remove('btn-success');
            submitButton.classList.add('btn-secondary');
            submitButton.innerHTML = `<i class="fas fa-clock me-2"></i>Complete las preguntas (${completedCount}/${TOTAL_QUESTIONS})`;
        }
        
        console.log(`Progreso: ${completedCount}/${TOTAL_QUESTIONS} (${percentage}%)`);
    }

    // --- INICIALIZACI√ìN ---
    
    // Setup contadores para todos los textareas
    document.querySelectorAll('textarea[name*="_reason"]').forEach(setupCharacterCounter);
    
    // Setup listeners para radio buttons
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateOverallProgress);
    });
    
    // Listener global para cambios en el formulario
    form.addEventListener('input', updateOverallProgress);
    
    // Validaci√≥n al enviar
    form.addEventListener('submit', function(e) {
        console.log('Enviando formulario...');
        
        // Verificaci√≥n final
        let missingFields = [];
        
        // Verificar cada caso y pregunta
        {% for case_data in all_cases_data %}
            {% for question in case_data.questions %}
                const radio_{{ case_data.case.case_id }}_{{ loop.index0 }} = document.querySelector('input[name="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_bool"]:checked');
                const textarea_{{ case_data.case.case_id }}_{{ loop.index0 }} = document.querySelector('textarea[name="q_{{ case_data.case.case_id }}_{{ loop.index0 }}_reason"]');
                
                if (!radio_{{ case_data.case.case_id }}_{{ loop.index0 }}) {
                    missingFields.push('Caso {{ case_data.case.case_id }}, Pregunta {{ loop.index }}: Falta seleccionar Verdadero/Falso');
                }
                
                if (!textarea_{{ case_data.case.case_id }}_{{ loop.index0 }} || textarea_{{ case_data.case.case_id }}_{{ loop.index0 }}.value.trim().length < MIN_CHARS) {
                    missingFields.push('Caso {{ case_data.case.case_id }}, Pregunta {{ loop.index }}: Justificaci√≥n insuficiente');
                }
            {% endfor %}
        {% endfor %}
        
        if (missingFields.length > 0) {
            e.preventDefault();
            alert('‚ö†Ô∏è Por favor corrija lo siguiente antes de enviar:\n\n' + missingFields.join('\n'));
            return false;
        }
        
        // Confirmar env√≠o
        const confirmSubmit = confirm(
            'üéØ ¬øEst√° seguro que desea enviar su examen?\n\n' +
            '‚ö†Ô∏è IMPORTANTE: No podr√° realizar cambios despu√©s de enviar.\n' +
            '‚úÖ Una vez enviado, recibir√° sus resultados inmediatamente.'
        );
        
        if (!confirmSubmit) {
            e.preventDefault();
            return false;
        }
        
        console.log('Formulario validado y enviado correctamente');
    });
    
    // Estado inicial
    updateOverallProgress();
    console.log('Sistema de examen inicializado correctamente');
});
</script>
{% endblock %}