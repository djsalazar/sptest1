{% extends 'base.html' %}
{% block content %}
<section class="result-detail-container">
    <h2>Detalle del Resultado #{{ result.id }}</h2>
    <p><strong>Fecha y hora:</strong> {{ result.timestamp }}</p>
    <p><strong>Estudiante:</strong> {{ result.student_id }}</p>
    <p><strong>Caso:</strong> {{ case.title }}</p>
    <p><strong>Puntaje total:</strong> {{ '%.2f'|format(result.score) }} / 100</p>
    <h3>Respuestas</h3>
    <ol>
        {% for answer in answers %}
        <li>
            <p><strong>Pregunta {{ loop.index }}:</strong> {{ case.questions[loop.index0].text }}</p>
            <p>Respuesta estudiante: <em>{{ 'Verdadero' if answer.user_bool else 'Falso' }}</em></p>
            <p>Respuesta correcta: <em>{{ 'Verdadero' if answer.correct else 'Falso' }}</em></p>
            <p>Justificación:</p>
            <blockquote>{{ answer.user_reason }}</blockquote>
            
            <!-- Breakdown básico -->
            <ul class="breakdown">
                <li>Veracidad: {{ '%.1f'|format(answer.breakdown.truth) }} pts</li>
                <li>Argumentación: {{ '%.1f'|format(answer.breakdown.argument) }} pts</li>
                {% if answer.breakdown.ai_penalty < 0 %}
                <li>Penalización IA: {{ '%.1f'|format(answer.breakdown.ai_penalty) }} pts</li>
                {% endif %}
                <li>Puntuación total: {{ '%.2f'|format(answer.score) }} pts</li>
            </ul>
            
            <!-- Análisis detallado de IA si está disponible -->
            {% if answer.breakdown.ai_analysis %}
            <div class="ai-analysis">
                <h4>Análisis de IA - Rúbrica Detallada</h4>
                <div class="criteria-scores">
                    <div class="criteria-grid">
                        <div class="criterion">
                            <span class="criterion-name">Opinión fundada:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.opinion_fundada }}">{{ answer.breakdown.ai_analysis.opinion_fundada }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Valores éticos:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.valores_eticos }}">{{ answer.breakdown.ai_analysis.valores_eticos }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Lenguaje y terminología:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.lenguaje_terminologia }}">{{ answer.breakdown.ai_analysis.lenguaje_terminologia }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Citas y precisión:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.citas_precision }}">{{ answer.breakdown.ai_analysis.citas_precision }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Estructura y coherencia:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.estructura_coherencia }}">{{ answer.breakdown.ai_analysis.estructura_coherencia }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Profundidad:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.profundidad_fundamentacion }}">{{ answer.breakdown.ai_analysis.profundidad_fundamentacion }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Capacidad crítica:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.capacidad_critica }}">{{ answer.breakdown.ai_analysis.capacidad_critica }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Presentación:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.presentacion_estilo }}">{{ answer.breakdown.ai_analysis.presentacion_estilo }}/5</span>
                        </div>
                        <div class="criterion">
                            <span class="criterion-name">Innovación:</span>
                            <span class="score score-{{ answer.breakdown.ai_analysis.innovacion_creatividad }}">{{ answer.breakdown.ai_analysis.innovacion_creatividad }}/5</span>
                        </div>
                    </div>
                </div>
                
                {% if answer.breakdown.feedback %}
                <div class="ai-feedback">
                    <h5>Feedback de IA:</h5>
                    <p>{{ answer.breakdown.feedback }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
    <h3>Eventos de registro</h3>
    {% if events %}
    <table class="event-table">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Tipo</th>
                <th>Detalles</th>
            </tr>
        </thead>
        <tbody>
            {% for ev in events %}
            <tr>
                <td>{{ ev.event_time }}</td>
                <td>{{ ev.event_type }}</td>
                <td>{{ ev.details }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No se registraron eventos.</p>
    {% endif %}
    <p><a href="{{ url_for('dashboard') }}">Volver al panel</a></p>
</section>
{% endblock %}